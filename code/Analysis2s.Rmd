---
title: "Analysis"
author: "Shakir Suleimanov"
date: "2024-03-26"
output: 
  html_document:
    #css: styles.css
    latex_engine : xelatex
    df_print: default
    highlight: zenburn
    toc: TRUE
    toc_depth: 4
mainfont : NanumGothic    
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Libs
```{r message=FALSE, warning=FALSE, include=FALSE}
source('Basic_metrics.R')
```


### Datapaths
```{r paths, echo=TRUE, message=FALSE, warning=FALSE}
counts <- c('../Data/Solo.out_1/Gene/raw/matrix.mtx.gz',
            '../Data/Solo.out_2/Gene/raw/matrix.mtx.gz')

genes <- c('../Data/Solo.out_1/Gene/raw/features.tsv.gz',
           '../Data/Solo.out_2/Gene/raw/features.tsv.gz')

barcodes <- c('../Data/Solo.out_1/Gene/raw/barcodes.tsv.gz',
              '../Data/Solo.out_2/Gene/raw/barcodes.tsv.gz')

filenames <- c('Solo1', 'Solo2')
```

### Two samples - no filtering
```{r no filtering, echo=TRUE, fig.height=12, fig.width=14, message=FALSE, warning=FALSE}
experiments_nf <- read_10X_samples(counts, barcodes, genes, 
                                filenames, emptydrops_run = FALSE, fdr_threshold = 0.05)

experiments_nf <- calculate_distributions(experiments_nf, 2)

experiments_nf <- multinomial_testing(experiments_nf, 2, prob=0.675)

pvals <- experiments_nf$non_filt_pvals

kp1sample_nf <- knee_plot_sample_distribution(experiments_nf, 1, 0.05)
kp2sample_nf <- knee_plot_sample_distribution(experiments_nf, 2, 0.05)
intersect_plot <- plot_intersections(experiments_nf, 2000)
bp_distributions <- plot_distributions_boxplots(experiments_nf$distributions, 2, 0.05)

kp1sample_nf
kp2sample_nf
intersect_plot
bp_distributions
```

### Two samples - filtering, binomial test with P-values from non-filtered data
```{r filtering1, echo=TRUE, fig.height=8, fig.width=14, message=FALSE, warning=FALSE}
experiments_f1 <- read_10X_samples(counts, barcodes, genes, 
                                filenames, emptydrops_run = TRUE, fdr_threshold = 0.05)

experiments_f1 <- calculate_distributions(experiments_f1, 2)

experiments_f1 <- assign_non_filt_pvals(experiments_f1, pvals)

experiments_f1 <- multinomial_testing(experiments_f1, 2, 0.675)

kp1sample_f1 <- knee_plot_sample_distribution(experiments_f1, 1, 0.05)
kp2sample_f1 <- knee_plot_sample_distribution(experiments_f1, 2, 0.05)

intersect_plot <- plot_intersections(experiments_f1)
bp_distributions <- plot_distributions_boxplots(experiments_f1$distributions, 2, 0.25)

kp1sample_f1
kp2sample_f1
intersect_plot
bp_distributions
```




### Two samples - filtering, binomial test with P(0.675)
```{r filtering2, echo=TRUE, fig.height=8, fig.width=14, message=FALSE, warning=FALSE}
experiments_f2 <- multinomial_testing(experiments_f1, 2, prob=0.675)

kp1sample_f2 <- knee_plot_sample_distribution(experiments_f2, 1, 0.05)
kp2sample_f2 <- knee_plot_sample_distribution(experiments_f2, 2, 0.05)

intersect_plot <- plot_intersections(experiments_f2)
bp_distributions <- plot_distributions_boxplots(experiments_f2$distributions, 2, 0.25)

kp1sample_f2
kp2sample_f2
intersect_plot
bp_distributions
```


